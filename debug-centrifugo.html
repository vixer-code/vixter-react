<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centrifugo Debug Tool</title>
    <script src="https://unpkg.com/centrifuge@5.0.1/dist/centrifuge.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .log { background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 10px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        input, button { padding: 8px; margin: 5px; }
        button { background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Centrifugo Debug Tool</h1>
        <p>This tool helps debug Centrifugo pub/sub issues in your chat app.</p>

        <!-- Connection Section -->
        <div class="section">
            <h2>1. Connection Test</h2>
            <div>
                <label>User ID: <input type="text" id="userId" value="test-user-123" /></label>
                <button onclick="connectToCentrifugo()">Connect</button>
                <button onclick="disconnect()">Disconnect</button>
            </div>
            <div id="connectionStatus" class="status info">Not connected</div>
            <div id="connectionLog" class="log"></div>
        </div>

        <!-- Subscription Section -->
        <div class="section">
            <h2>2. Channel Subscription Test</h2>
            <div>
                <label>Channel: <input type="text" id="channelName" value="conversation:test-conv-456" /></label>
                <button onclick="subscribeToChannel()" id="subscribeBtn" disabled>Subscribe</button>
                <button onclick="unsubscribeFromChannel()" id="unsubscribeBtn" disabled>Unsubscribe</button>
            </div>
            <div id="subscriptionStatus" class="status info">Not subscribed</div>
            <div id="subscriptionLog" class="log"></div>
        </div>

        <!-- Publishing Section -->
        <div class="section">
            <h2>3. Message Publishing Test</h2>
            <div>
                <label>Message: <input type="text" id="messageText" value="Hello from debug tool!" /></label>
                <button onclick="publishMessage()" id="publishBtn" disabled>Publish via API</button>
            </div>
            <div id="publishStatus" class="status info">Ready to publish</div>
            <div id="publishLog" class="log"></div>
        </div>

        <!-- Received Messages Section -->
        <div class="section">
            <h2>4. Received Messages</h2>
            <div id="messagesLog" class="log">Waiting for messages...</div>
        </div>
    </div>

    <script>
        let centrifuge = null;
        let subscription = null;
        let currentChannel = null;

        function log(elementId, message, type = 'info') {
            const logElement = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            logElement.textContent += logMessage;
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateStatus(elementId, message, type = 'info') {
            const statusElement = document.getElementById(elementId);
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        async function getToken(userId) {
            try {
                const response = await fetch('https://vixter-react-llyd.vercel.app/api/centrifugo/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ userId })
                });

                if (!response.ok) {
                    throw new Error(`Token request failed: ${response.status}`);
                }

                const data = await response.json();
                log('connectionLog', `Token received: ${data.token.substring(0, 20)}...`);
                return data.token;
            } catch (error) {
                log('connectionLog', `Token error: ${error.message}`, 'error');
                throw error;
            }
        }

        async function connectToCentrifugo() {
            const userId = document.getElementById('userId').value;
            if (!userId) {
                alert('Please enter a User ID');
                return;
            }

            try {
                updateStatus('connectionStatus', 'Connecting...', 'info');
                log('connectionLog', `Attempting to connect with user ID: ${userId}`);

                const token = await getToken(userId);
                
                if (centrifuge) {
                    centrifuge.disconnect();
                }

                centrifuge = new Centrifuge('wss://vixter-centrifugo.fly.dev/connection/websocket', {
                    token: token,
                    getToken: () => getToken(userId)
                });

                centrifuge.on('connecting', (ctx) => {
                    log('connectionLog', `Connecting: ${ctx.code} - ${ctx.reason}`);
                    updateStatus('connectionStatus', 'Connecting...', 'info');
                });

                centrifuge.on('connected', (ctx) => {
                    log('connectionLog', `Connected via ${ctx.transport}`);
                    updateStatus('connectionStatus', `Connected via ${ctx.transport}`, 'success');
                    document.getElementById('subscribeBtn').disabled = false;
                    document.getElementById('publishBtn').disabled = false;
                });

                centrifuge.on('disconnected', (ctx) => {
                    log('connectionLog', `Disconnected: ${ctx.code} - ${ctx.reason}`);
                    updateStatus('connectionStatus', `Disconnected: ${ctx.reason}`, 'error');
                    document.getElementById('subscribeBtn').disabled = true;
                    document.getElementById('unsubscribeBtn').disabled = true;
                    document.getElementById('publishBtn').disabled = true;
                });

                centrifuge.on('error', (ctx) => {
                    log('connectionLog', `Connection error: ${ctx.message}`, 'error');
                    updateStatus('connectionStatus', `Error: ${ctx.message}`, 'error');
                });

                centrifuge.connect();

            } catch (error) {
                log('connectionLog', `Connection failed: ${error.message}`, 'error');
                updateStatus('connectionStatus', `Failed: ${error.message}`, 'error');
            }
        }

        function disconnect() {
            if (centrifuge) {
                centrifuge.disconnect();
                centrifuge = null;
                subscription = null;
                currentChannel = null;
                updateStatus('connectionStatus', 'Disconnected', 'info');
                updateStatus('subscriptionStatus', 'Not subscribed', 'info');
                log('connectionLog', 'Manually disconnected');
            }
        }

        function subscribeToChannel() {
            const channelName = document.getElementById('channelName').value;
            if (!channelName || !centrifuge) {
                alert('Please enter a channel name and ensure you are connected');
                return;
            }

            try {
                if (subscription) {
                    subscription.unsubscribe();
                }

                updateStatus('subscriptionStatus', 'Subscribing...', 'info');
                log('subscriptionLog', `Subscribing to channel: ${channelName}`);

                subscription = centrifuge.newSubscription(channelName);
                currentChannel = channelName;

                subscription.on('publication', (ctx) => {
                    log('messagesLog', `üì® RECEIVED: ${JSON.stringify(ctx.data, null, 2)}`);
                    log('subscriptionLog', `Message received from ${channelName}`);
                });

                subscription.on('subscribing', (ctx) => {
                    log('subscriptionLog', `Subscribing: ${ctx.code} - ${ctx.reason}`);
                });

                subscription.on('subscribed', (ctx) => {
                    log('subscriptionLog', `‚úÖ Successfully subscribed to ${channelName}`);
                    updateStatus('subscriptionStatus', `Subscribed to ${channelName}`, 'success');
                    document.getElementById('unsubscribeBtn').disabled = false;
                });

                subscription.on('unsubscribed', (ctx) => {
                    log('subscriptionLog', `Unsubscribed: ${ctx.code} - ${ctx.reason}`);
                    updateStatus('subscriptionStatus', 'Not subscribed', 'info');
                    document.getElementById('unsubscribeBtn').disabled = true;
                });

                subscription.on('error', (ctx) => {
                    log('subscriptionLog', `‚ùå Subscription error: ${ctx.message}`, 'error');
                    updateStatus('subscriptionStatus', `Error: ${ctx.message}`, 'error');
                });

                subscription.subscribe();

            } catch (error) {
                log('subscriptionLog', `Subscription failed: ${error.message}`, 'error');
                updateStatus('subscriptionStatus', `Failed: ${error.message}`, 'error');
            }
        }

        function unsubscribeFromChannel() {
            if (subscription) {
                subscription.unsubscribe();
                subscription = null;
                currentChannel = null;
                log('subscriptionLog', 'Manually unsubscribed');
            }
        }

        async function publishMessage() {
            const channelName = document.getElementById('channelName').value;
            const messageText = document.getElementById('messageText').value;

            if (!channelName || !messageText) {
                alert('Please enter both channel name and message');
                return;
            }

            try {
                updateStatus('publishStatus', 'Publishing...', 'info');
                log('publishLog', `Publishing to ${channelName}: ${messageText}`);

                const response = await fetch('https://vixter-react-llyd.vercel.app/api/centrifugo/publish', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        channel: channelName,
                        data: {
                            type: 'new_message',
                            message: {
                                id: 'debug-' + Date.now(),
                                senderId: document.getElementById('userId').value,
                                content: messageText,
                                timestamp: Date.now(),
                                type: 'text'
                            },
                            conversationId: channelName.split(':')[1],
                            timestamp: Date.now()
                        }
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Publish failed: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                log('publishLog', `‚úÖ Message published successfully: ${JSON.stringify(result)}`);
                updateStatus('publishStatus', 'Message published!', 'success');

                // Clear the message input
                document.getElementById('messageText').value = '';

            } catch (error) {
                log('publishLog', `‚ùå Publish failed: ${error.message}`, 'error');
                updateStatus('publishStatus', `Failed: ${error.message}`, 'error');
            }
        }

        // Auto-connect on page load for convenience
        window.addEventListener('load', () => {
            log('connectionLog', 'üîß Debug tool loaded. Click Connect to start testing.');
        });
    </script>
</body>
</html>
