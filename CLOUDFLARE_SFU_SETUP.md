# Cloudflare Realtime SFU Setup Guide

Este guia explica como configurar o Cloudflare Realtime SFU para chamadas de voz e v√≠deo 1:1 na aplica√ß√£o Vixter.

## Sobre o Cloudflare Realtime SFU

O [Cloudflare Realtime SFU](https://developers.cloudflare.com/realtime/) √© um servidor de m√≠dia poderoso que roteia eficientemente streams de v√≠deo e √°udio entre participantes. Ele roda na rede global da Cloudflare em centenas de cidades ao redor do mundo.

## Vis√£o Geral

O sistema de chamadas utiliza:
- **Cloudflare SFU** para roteamento de m√≠dia
- **Centrifugo** para sinaliza√ß√£o em tempo real
- **WebRTC** para conex√µes peer-to-peer
- **JWT tokens** para autentica√ß√£o

## Configura√ß√£o do Cloudflare

### 1. Criar conta Cloudflare

1. Acesse [cloudflare.com](https://cloudflare.com)
2. Crie uma conta ou fa√ßa login
3. Anote seu **Account ID** (encontrado no dashboard)

### 2. Configurar API Token

1. V√° para **My Profile** > **API Tokens**
2. Clique em **Create Token**
3. Use o template **Custom token**
4. Configure as permiss√µes:
   - **Account** > **Cloudflare Stream** > **Edit**
   - **Zone** > **Zone** > **Read** (opcional)
5. Salve o token gerado

### 3. Configurar vari√°veis de ambiente

#### No Vercel Dashboard:

1. Acesse seu projeto no [Vercel Dashboard](https://vercel.com/dashboard)
2. V√° em **Settings** ‚Üí **Environment Variables**
3. Adicione as seguintes vari√°veis:

```env
# Cloudflare Realtime SFU Configuration
# Obtenha essas credenciais em: Cloudflare Dashboard > Realtime > SFU
CLOUDFLARE_APP_ID=seu_app_id_aqui
CLOUDFLARE_APP_SECRET=seu_app_secret_aqui

# Optional: Custom RTC API URL (defaults to Cloudflare's API)
CLOUDFLARE_RTC_URL=https://rtc.live.cloudflare.com/v1

# JWT Secret para tokens de autentica√ß√£o (opcional)
JWT_SECRET=sua_chave_secreta_aqui
```

#### Como obter as credenciais do Cloudflare:

1. **Acesse o Cloudflare Dashboard**
2. **V√° para Realtime** ‚Üí **SFU**
3. **Crie um novo App** ou use um existente
4. **Copie o App ID e App Secret**

#### ‚ö†Ô∏è Importante:
- Certifique-se de que as vari√°veis est√£o configuradas para **Production**, **Preview** e **Development**
- Ap√≥s adicionar as vari√°veis, fa√ßa um novo **deploy** do projeto
- Verifique os logs do Vercel para confirmar que as vari√°veis est√£o sendo carregadas

## Arquitetura do Sistema

```
Frontend (React)
    ‚Üì WebRTC + Cloudflare STUN
Cloudflare Realtime SFU
    ‚Üì Sinaliza√ß√£o
Centrifugo (WebSocket)
    ‚Üì API Calls
Backend (Next.js)
```

## Fluxo de Chamada (Modelo de Sala)

### 1. Criar Sala de Chamada
1. Usu√°rio A clica em "üè† Criar Sala" no chat
2. Frontend chama `/api/start-call`
3. Backend cria sess√£o no Cloudflare Realtime SFU
4. Usu√°rio A entra automaticamente na sala
5. Sistema envia notifica√ß√£o para Usu√°rio B: "Sala de Chamada Dispon√≠vel"

### 2. Entrar na Sala
1. Usu√°rio B recebe notifica√ß√£o: "Usu√°rio A criou uma sala de v√≠deo. Clique para entrar!"
2. Usu√°rio B clica em "üö™ Entrar na Sala"
3. Frontend chama `/api/accept-call`
4. Usu√°rio B entra na sala existente
5. Ambos os usu√°rios est√£o conectados via WebRTC

### 3. Durante a Chamada
1. Usu√°rios podem mutar/desmutar √°udio
2. Usu√°rios podem ligar/desligar v√≠deo
3. Usu√°rios podem compartilhar tela
4. Sistema gerencia conex√µes WebRTC automaticamente

### 4. Vantagens do Modelo de Sala
- ‚úÖ **Sem spam**: Apenas uma notifica√ß√£o por sala criada
- ‚úÖ **Flex√≠vel**: Usu√°rio B pode entrar quando quiser
- ‚úÖ **Intuitivo**: Interface clara de "criar sala" vs "entrar na sala"
- ‚úÖ **Persistente**: Sala fica dispon√≠vel at√© ser fechada

## APIs Implementadas

### POST /api/start-call
Inicia uma nova chamada.

**Request:**
```json
{
  "conversationId": "conv_123",
  "callerId": "userA",
  "calleeId": "userB"
}
```

**Response:**
```json
{
  "success": true,
  "roomId": "call_conv_123_1234567890",
  "callerToken": "jwt_token_here",
  "calleeToken": "jwt_token_here",
  "expires": 1234567890000
}
```

### POST /api/accept-call
Aceita uma chamada existente.

**Request:**
```json
{
  "roomId": "call_conv_123_1234567890",
  "userId": "userB",
  "conversationId": "conv_123"
}
```

**Response:**
```json
{
  "success": true,
  "roomId": "call_conv_123_1234567890",
  "token": "jwt_token_here",
  "expires": 1234567890000
}
```

### POST /api/end-call
Encerra uma chamada.

**Request:**
```json
{
  "roomId": "call_conv_123_1234567890",
  "userId": "userA",
  "conversationId": "conv_123"
}
```

## Componentes Frontend

### useCall Hook
Gerencia estado e l√≥gica WebRTC:
- Conex√£o peer-to-peer
- Captura de m√≠dia
- Controles de √°udio/v√≠deo
- Compartilhamento de tela

### CallInterface Component
Interface de usu√°rio para chamadas:
- Bot√µes de controle
- Visualiza√ß√£o de v√≠deo
- Modal de chamada recebida

### Integra√ß√£o no ChatInterface
- Bot√£o "Ligar" em conversas 1:1
- Notifica√ß√µes de chamada recebida
- Estado de chamada ativa

## Recursos Implementados

### ‚úÖ Funcionalidades B√°sicas
- [x] Chamadas 1:1 (√°udio + v√≠deo)
- [x] Sinaliza√ß√£o via Centrifugo
- [x] Tokens JWT para autentica√ß√£o
- [x] Interface de usu√°rio responsiva
- [x] Controles de √°udio/v√≠deo
- [x] Notifica√ß√µes de chamada

### ‚úÖ Recursos Avan√ßados
- [x] Compartilhamento de tela
- [x] Mute/unmute
- [x] Ligar/desligar c√¢mera
- [x] Estados de chamada (calling, ringing, connected)
- [x] Cleanup autom√°tico

### üîÑ Pr√≥ximos Passos (Futuro)
- [ ] Chamadas em grupo
- [x] Grava√ß√£o de chamadas
- [ ] Controle de qualidade adaptativa
- [ ] Presen√ßa em tempo real
- [ ] Hist√≥rico de chamadas

## Custos

### Cloudflare SFU
- **Gratuito** at√© 1 TB/m√™s de egress
- **$0.10/GB** ap√≥s o limite gratuito
- **$0.50/GB** para grava√ß√µes

### Centrifugo
- **Gratuito** (j√° configurado)
- Sem custo adicional para sinaliza√ß√£o

### Estimativa de Uso
- 1 chamada de 1 hora = ~100MB
- 1 TB = ~10.000 horas de chamadas
- Custo mensal: **$0** at√© 1 TB

## Troubleshooting

### Problemas Comuns

1. **Erro de permiss√£o de c√¢mera/microfone**
   - Verifique se o site tem permiss√£o
   - Use HTTPS (obrigat√≥rio para WebRTC)

2. **Falha na conex√£o WebRTC**
   - Verifique configura√ß√£o de STUN/TURN
   - Teste em rede local primeiro

3. **Token JWT inv√°lido**
   - Verifique `CLOUDFLARE_API_TOKEN`
   - Confirme Account ID correto

4. **Centrifugo n√£o conecta**
   - Verifique `CENTRIFUGO_WS_URL`
   - Confirme token de autentica√ß√£o

### Logs de Debug

Ative logs detalhados no console:
```javascript
// No useCall hook
console.log('WebRTC connection state:', peerConnection.connectionState);
console.log('Call status:', callStatus);
```

## Seguran√ßa

### Tokens JWT
- Expira√ß√£o de 1 hora
- Claims espec√≠ficos por usu√°rio
- Valida√ß√£o no backend

### Permiss√µes de Canal
- Apenas participantes da conversa
- Valida√ß√£o de room ID
- Cleanup autom√°tico

### WebRTC
- Conex√µes criptografadas
- Sem armazenamento de m√≠dia
- Controle de permiss√µes do navegador

## Troubleshooting

### Erro: "SDP contains no ice-ufrag. Please ensure the SDP is valid."
- **Causa**: O SDP estava vazio e precisa conter campos obrigat√≥rios como `ice-ufrag`, `ice-pwd`, etc.
- **Solu√ß√£o**: ‚úÖ Corrigido automaticamente - o sistema agora gera um SDP v√°lido com todos os campos necess√°rios

### Erro: "Body JSON validation error: sessionDescription"
- **Causa**: A API do Cloudflare Realtime SFU espera um campo `sessionDescription` no body da requisi√ß√£o
- **Solu√ß√£o**: ‚úÖ Corrigido automaticamente - o sistema agora envia o payload correto

### Erro: "Invalid bearer token"
- **Causa**: Vari√°veis de ambiente `CLOUDFLARE_APP_ID` e `CLOUDFLARE_APP_SECRET` n√£o configuradas
- **Solu√ß√£o**: Configure as vari√°veis no Vercel Dashboard e fa√ßa um novo deploy

### Debug Logs
O sistema agora inclui logs detalhados para debug:
- üîß Status das vari√°veis de ambiente
- üì¶ Payload da requisi√ß√£o
- ‚úÖ Resposta da API
- ‚ùå Erros detalhados

Verifique os logs do Vercel para diagnosticar problemas.

## Monitoramento

### M√©tricas Importantes
- Taxa de sucesso de chamadas
- Lat√™ncia de conex√£o
- Qualidade de √°udio/v√≠deo
- Uso de largura de banda

### Alertas Recomendados
- Falhas de autentica√ß√£o > 5%
- Lat√™ncia > 500ms
- Uso de banda > 80% do limite

---

**Nota:** Este sistema est√° otimizado para chamadas 1:1. Para chamadas em grupo, ser√° necess√°rio implementar l√≥gica adicional de gerenciamento de m√∫ltiplos peers.
